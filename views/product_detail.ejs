<%- include('partials/header') %>

<div class="container py-5">
    <nav aria-label="breadcrumb" class="mb-4 animate__animated animate__fadeInDown">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/" class="text-decoration-none" style="color: var(--text-secondary);">Home</a></li>
            <li class="breadcrumb-item"><a href="/products" class="text-decoration-none" style="color: var(--text-secondary);">Products</a></li>
            <li class="breadcrumb-item active" aria-current="page" style="color: var(--text-primary);"><%= product.name %></li>
        </ol>
    </nav>

    <div class="glass-card overflow-hidden animate__animated animate__fadeInUp">
        <div class="row g-0">
            <div class="col-md-6 d-flex align-items-center justify-content-center p-4" style="background: rgba(255,255,255,0.05);">
                <img src="<%= product.product_images && product.product_images[0] ? product.product_images[0].url : 'https://via.placeholder.com/500' %>" class="img-fluid rounded shadow-lg" alt="<%= product.name %>" style="max-height: 500px; object-fit: contain;">
            </div>
            <div class="col-md-6">
                <div class="p-5 d-flex flex-column h-100">
                    <div class="mb-auto">
                        <span class="badge bg-primary bg-opacity-50 text-white mb-2 px-3 py-2 rounded-pill">
                            <%= product.categories ? product.categories.name : 'Uncategorized' %>
                        </span>
                        <h1 class="display-5 fw-bold mb-3" style="color: var(--text-primary);"><%= product.name %></h1>
                        <h2 class="fw-bold mb-4 display-6" style="color: var(--accent-color);"><%= product.price.toLocaleString() %> VND</h2>
                        
                        <div class="mb-4">
                            <h5 class="fw-bold mb-2" style="color: var(--text-primary);">Description</h5>
                            <p class="lead fs-6" style="color: var(--text-secondary);"><%= product.description %></p>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex align-items-center gap-2" style="color: var(--text-secondary);">
                                <i class="fas fa-box-open"></i>
                                <span>Availability:</span>
                                <% if (product.stock > 0) { %>
                                    <span class="text-success fw-bold">In Stock (<%= product.stock %> available)</span>
                                <% } else { %>
                                    <span class="text-danger fw-bold">Out of Stock</span>
                                <% } %>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-4" style="border-top: 1px solid rgba(255,255,255,0.1);">
                        <div class="row g-3 align-items-end">
                            <div class="col-sm-4">
                                <label for="qty" class="form-label fw-bold small text-uppercase" style="color: var(--text-secondary);">Quantity</label>
                                <div class="input-group">
                                    <button class="btn btn-outline-light" type="button" onclick="document.getElementById('qty').stepDown()">-</button>
                                    <input type="number" id="qty" class="form-control text-center glass-input" value="1" min="1" max="<%= product.stock %>" style="color: var(--text-primary);">
                                    <button class="btn btn-outline-light" type="button" onclick="document.getElementById('qty').stepUp()">+</button>
                                </div>
                            </div>
                            <div class="col-sm-8">
                                <button class="btn btn-primary w-100 py-2 fw-bold glass-btn add-to-cart-detail" data-id="<%= product.id %>" <%= product.stock <= 0 ? 'disabled' : '' %>>
                                    <i class="fas fa-shopping-cart me-2"></i> Add to Cart
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="glass-card mt-5 p-5 animate__animated animate__fadeInUp">
        <h3 class="mb-4" style="color: var(--text-primary);">Reviews</h3>
        
        <% if (user) { %>
            <div class="mb-5">
                <h5 class="mb-3" style="color: var(--text-primary);">Write a Review</h5>
                <form id="reviewForm">
                    <input type="hidden" id="product_id" value="<%= product.id %>">
                    <div class="mb-3">
                        <label class="form-label" style="color: var(--text-secondary);">Rating</label>
                        <div class="rating">
                            <i class="far fa-star fa-lg star" data-value="1"></i>
                            <i class="far fa-star fa-lg star" data-value="2"></i>
                            <i class="far fa-star fa-lg star" data-value="3"></i>
                            <i class="far fa-star fa-lg star" data-value="4"></i>
                            <i class="far fa-star fa-lg star" data-value="5"></i>
                            <input type="hidden" id="rating" name="rating" value="0">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label" style="color: var(--text-secondary);">Your Review</label>
                        <textarea class="form-control glass-input" id="content" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary glass-btn">Submit Review</button>
                </form>
            </div>
        <% } else { %>
            <div class="alert glass-alert mb-5" role="alert">
                Please <a href="/login" class="alert-link">login</a> to write a review.
            </div>
        <% } %>

        <div class="reviews-list">
            <% if (reviews && reviews.length > 0) { %>
                <% reviews.forEach(review => { %>
                    <div class="review-item mb-4 pb-4" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center">
                                <div class="avatar me-3" style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-primary); font-weight: bold;">
                                    <%= (review.users && review.users.name) ? review.users.name.charAt(0).toUpperCase() : 'U' %>
                                </div>
                                <div>
                                    <h6 class="mb-0" style="color: var(--text-primary);"><%= (review.users && review.users.name) || 'Anonymous' %></h6>
                                    <small style="color: var(--text-secondary);"><%= new Date(review.created_at).toLocaleDateString() %></small>
                                </div>
                            </div>
                            <div class="text-warning">
                                <% for(let i=0; i<5; i++) { %>
                                    <i class="<%= i < review.rating ? 'fas' : 'far' %> fa-star"></i>
                                <% } %>
                            </div>
                        </div>
                        <p class="mb-0" style="color: var(--text-secondary);"><%= review.content %></p>
                    </div>
                <% }); %>
            <% } else { %>
                <p class="text-center" style="color: var(--text-secondary);">No reviews yet. Be the first to review!</p>
            <% } %>
        </div>
    </div>
</div>

<style>
    .rating .star {
        cursor: pointer;
        color: #ffc107;
        transition: transform 0.2s;
    }
    .rating .star:hover {
        transform: scale(1.2);
    }
    .glass-alert {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--text-primary);
    }
</style>

<script>
    // Star Rating Logic
    const stars = document.querySelectorAll('.rating .star');
    const ratingInput = document.getElementById('rating');
    
    stars.forEach(star => {
        star.addEventListener('click', function() {
            const value = this.dataset.value;
            ratingInput.value = value;
            updateStars(value);
        });
        
        star.addEventListener('mouseover', function() {
            updateStars(this.dataset.value);
        });
        
        star.addEventListener('mouseout', function() {
            updateStars(ratingInput.value);
        });
    });

    function updateStars(value) {
        stars.forEach(s => {
            if (s.dataset.value <= value) {
                s.classList.remove('far');
                s.classList.add('fas');
            } else {
                s.classList.remove('fas');
                s.classList.add('far');
            }
        });
    }

    // Review Form Submit
    const reviewForm = document.getElementById('reviewForm');
    if (reviewForm) {
        reviewForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const product_id = document.getElementById('product_id').value;
            const rating = document.getElementById('rating').value;
            const content = document.getElementById('content').value;

            if (rating == 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Rating Required',
                    text: 'Please select a star rating.',
                    background: 'rgba(255, 255, 255, 0.1)',
                    color: '#fff'
                });
                return;
            }

            try {
                const res = await fetch('/reviews', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_id, rating, content })
                });

                if (res.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Review Submitted!',
                        text: 'Thank you for your feedback.',
                        background: 'rgba(255, 255, 255, 0.1)',
                        color: '#fff'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to submit review.',
                        background: 'rgba(255, 255, 255, 0.1)',
                        color: '#fff'
                    });
                }
            } catch (err) {
                console.error(err);
            }
        });
    }

    // Add to Cart Logic (Existing)
    document.querySelector('.add-to-cart-detail').addEventListener('click', async function() {
        const productId = this.dataset.id;
        const qty = document.getElementById('qty').value;
        
        try {
            const res = await fetch('/api/cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ productId, qty })
            });
            
            if (res.ok) {
                Swal.fire({
                    icon: 'success',
                    title: 'Added to Cart!',
                    text: 'The product has been added to your cart.',
                    showConfirmButton: false,
                    timer: 1500,
                    background: 'rgba(255, 255, 255, 0.1)',
                    color: '#fff',
                    backdrop: `rgba(0,0,0,0.4)`
                });
            } else {
                const data = await res.json();
                if (res.status === 401) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Please Login',
                        text: 'You need to login to add items to cart.',
                        showCancelButton: true,
                        confirmButtonText: 'Login',
                        background: 'rgba(255, 255, 255, 0.1)',
                        color: '#fff'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = '/login';
                        }
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: data.error || 'Something went wrong!',
                        background: 'rgba(255, 255, 255, 0.1)',
                        color: '#fff'
                    });
                }
            }
        } catch (err) {
            console.error(err);
        }
    });
</script>

<%- include('partials/footer') %>
